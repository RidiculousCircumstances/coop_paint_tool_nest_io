<!DOCTYPE html>
<html>
	<head>
		<meta name="Authorization" content="11111111111111111111111111111">
		<script src="https://code.jquery.com/jquery-3.6.3.min.js"
				integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
		<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"
			integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI"
			crossorigin="anonymous"></script>
		<title>Отправка сообщения</title>
	</head>
	
	<body style="background-color: rgb(229, 204, 231);">
		<h2 class="js-current-id" width="200px" style="right: 100px; position: absolute"> </h2>
		<div style="position: absolute; left: 100px;">

				
			<div  style="position: absolute; left: 100px; top: 100px">
				<label for="chat-id">Id комнаты</label>
				<input id="chat-id" class="js-chatId" type="text" />
				<button class="js-chat-id-button">Установить комнату</button>

			</div>

			<div style="background-color: bisque;
								width: 200px;
								height: 100px;
								position: absolute;
								top: 200px;
								left: 100px">
			<label for="msgText" msgText">Введите сообщение</label>
			<input id="msgText" class="js-data" type="text">
			<button class="js-button">Отправить</button>
		</div>
		</div>

		<div style="background-color: bisque;
					width: 200px;
					height: auto;
					position: absolute;
					top: 310px;
					left: 200px">
			<ul class="js-messages">Сообщения:

			</ul>
		</div>

		</form>
	</body>
	<script>
		const token = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3QyMkBib2JvLnRvIiwidXNlcklkIjo1LCJpYXQiOjE2NzM3NzQ0NDUsImV4cCI6MTY3MzgxMDQ0NX0.baMG3E9lCeeOoFL7RFNLvzmBHQ47S6WesNrRRwap6Z8"
		const url = "http://83.246.208.128:5000";
		const method = "post";
		const button = $('.js-button');

		let chatIdInput = '';

		const socket = io('ws://83.246.208.128:5000');

		const list = $('.js-messages');

		const chatIdIn = $('.js-chatId');
		const chatIdBtn = $('.js-chat-id-button');


		socket.on('chatMessage', (data) => {
			console.log(111);
			$.ajax({
				url: `${url}/message/${data.messageId}`,
				type: 'get',
				beforeSend: (req) => {
					req.setRequestHeader("Authorization", token)
				},
				complete: (res) => { 
					const message = res.responseJSON;
	
					if (list.children) {

					}
					list.append(`<li><div style="width: 200px; height: auto	">${message.nickname} пишет: ${message.text} </div> </li>`);
				}})
		});

		const msgEl = (message) => {
			return `<li><div style="width: 130px; height: auto; margin-bottom: 4px	">${message.nickname} пишет: ${message.text} </div> </li>`
		}


// Отправка сообщения
		const actionSend = () => {
			const data = $('.js-data').val();
			console.log(data)
			$.ajax({
				url: `${url}/message`,
				type: 'post',
				data: {
					chatId: chatIdInput,
					text: data,
				},
				beforeSend: (req) => {
					req.setRequestHeader("Authorization", token)
				},
				// complete: () => {
				// 	list.append(msgEl({nickname: "not implemented", text: data}));
				// }

			})
			
		}

	//Установить комнату

		const actionSetRoom = () => {
			chatIdInput = chatIdIn.val();
			socket.emit('joinToChat', { chatId: chatIdInput });
			const currentId = $('.js-current-id');
			currentId.text(chatIdInput);
			$.ajax({
				url: `${url}/chat/${chatIdInput}`,
				type: 'get',
				beforeSend: (req) => {
					req.setRequestHeader("Authorization", token)
				},
				complete: (res) => {
					const msgs = res.responseJSON.messages;
					let lastMsgs = [];
					if (msgs.length > 10) {
						lastMsgs = msgs.slice(msgs.length - 10);
					} else {
						lastMsgs = msgs;
					}
					console.log(lastMsgs);
					
					lastMsgs.reverse().map(msg => {
						
						list.append(msgEl(msg));

					})
				}
			});
		}

		button.on('click', () => {

			actionSend();
		});

		chatIdBtn.on('click', () => {
			actionSetRoom();
		});

		


	</script>
</html>